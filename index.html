<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‡¶≤‡ßá‡¶¨‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü (Online)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body{font-family: "Noto Sans Bengali", Arial, sans-serif; background:#f4f4f4; color:#222}
  header{background:#0077cc;color:#fff;padding:14px;text-align:center;font-weight:600}
  .app{max-width:1100px;margin:18px auto;padding:16px;background:#fff;border-radius:8px;box-shadow:0 4px 18px rgba(0,0,0,0.08)}
  .hidden{display:none}
  table{width:100%;border-collapse:collapse}
  tr { transition: background-color .3s; cursor:pointer }
  tr:hover { background:#ffecec }
  .red-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:red;margin-right:6px}
  th,td{padding:8px;border:1px solid #e8e8e8;text-align:center}
  th{background:#0077cc;color:#fff}
  .red{background:#ffefef}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .small{font-size:13px;color:#555}
  @media(max-width:820px){ .controls{flex-direction:column} }
  .print-area { padding:10px; background:#fff; }
</style>
</head>
<body>
<header>‡¶≤‡ßá‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶ú ‡¶ì ‡¶¨‡¶ø‡¶≤ ‚Äî Online</header>

<div class="app" id="loginPage">
  <h4>‡¶≤‡¶ó‡¶á‡¶®</h4>
  <div class="mb-2">
    <button class="btn btn-primary" onclick="adminLogin()">Admin Login</button>
    <button class="btn btn-sm btn-secondary float-right" onclick="downloadServerCSV()">Download Server CSV</button>
    <label class="btn btn-sm btn-info mb-0 float-right mr-2">Import CSV <input id="csvFile" type="file" accept=".csv" style="display:none" onchange="importCSV(event)"></label>
    <button class="btn btn-sm btn-secondary float-right mr-2" onclick="exportCSV()">Export CSV (local)</button>
  </div>
  <p class="small">Data saved on server (multi-user). Use import/export to migrate data.</p>
</div>

<div class="app hidden" id="passwordBox">
  <h5>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®</h5>
  <div class="d-flex" style="gap:8px">
    <input id="adminPass" type="password" class="form-control" placeholder="Password">
    <button class="btn btn-primary" onclick="checkPassword()">Submit</button>
    <button class="btn btn-secondary" onclick="backToLogin()">Back</button>
  </div>
</div>

<div class="app hidden" id="dashboard">
  <div class="d-flex align-items-center mb-2">
    <button class="btn btn-sm btn-outline-secondary tab-btn" id="dailyTabBtn" onclick="showTab('daily')">Daily Work</button>
    <button class="btn btn-sm btn-outline-secondary tab-btn" id="permTabBtn" onclick="showTab('perm')">Permanent Workers</button>
    <button class="btn btn-sm btn-outline-secondary tab-btn" onclick="window.location.href='chart.html'">üìä Show Chart</button>
    <div style="flex:1"></div>
    <input id="globalSearch" class="form-control" placeholder="Search by name, date or description" style="max-width:360px" oninput="renderDailyTable()" />
  </div>

  <div id="dailySection">
    <h5>‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶ï‡¶æ‡¶ú</h5>
    <div id="adminControls" class="mb-2 hidden">
      <div class="controls">
        <input id="nameInput" list="namesList" class="form-control" placeholder="‡¶®‡¶æ‡¶Æ" />
        <datalist id="namesList"></datalist>
        <input id="dateInput" type="date" class="form-control" />
        <input id="detailsInput" class="form-control" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ (‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£: Payment, Brick work)" />
        <input id="bakiInput" type="number" class="form-control" placeholder="‡¶¨‡¶æ‡¶ï‡ßÄ" oninput="recalcTotalAdd()" />
        <input id="jamaInput" type="number" class="form-control" placeholder="‡¶ú‡¶Æ‡¶æ" oninput="recalcTotalAdd()" />
        <input id="totalInput" type="number" class="form-control" placeholder="‡¶Æ‡ßã‡¶ü (auto)" />
        <select id="sectionInput" class="form-control">
          <option value="daily">Daily</option>
          <option value="permanent">Permanent</option>
        </select>
        <button class="btn btn-primary" onclick="addRecord()">Add</button>
      </div>
      <div class="small mt-1">Tip: total auto-calculates as ‡¶¨‡¶æ‡¶ï‡ßÄ + ‡¶ú‡¶Æ‡¶æ. "Payment" or ‡¶ú‡¶Æ‡¶æ>0 will highlight row red.</div>
    </div>

    <table id="dailyTable" class="table table-sm">
      <thead><tr><th>‡¶®‡¶æ‡¶Æ</th><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th>‡¶¨‡¶æ‡¶ï‡ßÄ</th><th>‡¶ú‡¶Æ‡¶æ</th><th>‡¶Æ‡ßã‡¶ü</th><th class="admin-only hidden">Action</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="permSection" class="hidden mt-3">
    <h5>‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶∂‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï</h5>
    <div class="small mb-2">Click a name to see detailed history (row-by-row) with running total. Use Print to print that worker's details.</div>
    <table id="workerTable" class="table table-sm">
      <thead><tr><th>‡¶®‡¶æ‡¶Æ</th><th>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ï‡ßÄ</th><th>‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ</th><th>‡¶Æ‡ßã‡¶ü (‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶®‡ßç‡¶∏)</th><th>‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶ú</th><th>‡¶∂‡ßá‡¶∑ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá?</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="app hidden" id="workerDetails">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h5 id="workerTitle">Worker</h5>
    <div>
      <button class="btn btn-sm btn-primary" onclick="window.print()">üñ®Ô∏è Print Details</button>
      <button class="btn btn-sm btn-secondary" onclick="closeWorkerDetails()">Back</button>
    </div>
  </div>

  <div class="print-area">
    <table class="table table-sm">
      <thead><tr><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th>‡¶¨‡¶æ‡¶ï‡ßÄ</th><th>‡¶ú‡¶Æ‡¶æ</th><th>‡¶Æ‡ßã‡¶ü</th><th>‡¶Æ‡ßã‡¶ü (‡¶∞‡¶æ‡¶®‡¶ø‡¶Ç)</th><th>Edit</th></tr></thead>
      <tbody id="workerDetailBody"></tbody>
    </table>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeEditModal()"><span aria-hidden="true">&times;</span></button></div>
      <div class="modal-body">
        <input type="hidden" id="editId">
        <div class="form-group"><label>‡¶®‡¶æ‡¶Æ</label><input id="editName" class="form-control" /></div>
        <div class="form-group"><label>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label><input id="editDate" type="date" class="form-control" /></div>
        <div class="form-group"><label>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</label><input id="editDetails" class="form-control" /></div>
        <div class="form-row">
          <div class="form-group col"><label>‡¶¨‡¶æ‡¶ï‡ßÄ</label><input id="editBaki" type="number" class="form-control" oninput="recalcTotalEdit()" /></div>
          <div class="form-group col"><label>‡¶ú‡¶Æ‡¶æ</label><input id="editJama" type="number" class="form-control" oninput="recalcTotalEdit()" /></div>
          <div class="form-group col"><label>‡¶Æ‡ßã‡¶ü</label><input id="editTotal" type="number" class="form-control" /></div>
        </div>
        <div class="form-group"><label>‡¶∏‡ßá‡¶ï‡¶∂‡¶®</label><select id="editSection" class="form-control"><option value="daily">Daily</option><option value="permanent">Permanent</option></select></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-dismiss="modal" onclick="closeEditModal()">Cancel</button><button class="btn btn-primary" onclick="saveEdit()">Save</button></div>
  </div></div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API_BASE = "/api"; // relative path works on Render
const STORAGE_KEY = 'laborRecords_v1';
let records = [];
let finishedStatus = {};
let mode = '';

/* ---------- Init ---------- */
function adminLogin(){ loginPage.classList.add('hidden'); passwordBox.classList.remove('hidden'); }
function backToLogin(){ passwordBox.classList.add('hidden'); loginPage.classList.remove('hidden'); }
function checkPassword(){ if(adminPass.value==='2005') openDashboard('admin'); else alert('Wrong password!'); }

async function openDashboard(t){
  mode = t;
  loginPage.classList.add('hidden');
  passwordBox.classList.add('hidden');
  dashboard.classList.remove('hidden');
  if(mode==='admin'){ adminControls.classList.remove('hidden'); document.querySelectorAll('.admin-only').forEach(e=>e.classList.remove('hidden')); }
  await loadFromServer();
  showTab('daily');
}

/* ---------- Server sync ---------- */
async function loadFromServer(){
  try{
    const res = await fetch(API_BASE + "/records");
    const data = await res.json();
    records = data.records || [];
    finishedStatus = data.finishedStatus || {};
    updateNamesDatalist(); renderDailyTable(); renderWorkerTable();
  }catch(e){ console.error("load error", e); alert("Failed to load server data"); }
}

async function pushFinished(){
  try{
    await fetch(API_BASE + "/finished", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(finishedStatus)
    });
  }catch(e){ console.error(e); }
}

/* ---------- Add / Edit / Delete ---------- */
function recalcTotalAdd(){ totalInput.value = (parseFloat(bakiInput.value)||0) + (parseFloat(jamaInput.value)||0); }
function recalcTotalEdit(){ editTotal.value = (parseFloat(editBaki.value)||0) + (parseFloat(editJama.value)||0); }

async function addRecord(){
  const name = nameInput.value.trim();
  const date = dateInput.value;
  const description = detailsInput.value.trim();
  const baki = parseFloat(bakiInput.value) || 0;
  const jama = parseFloat(jamaInput.value) || 0;
  const total = parseFloat(totalInput.value) || (baki + jama);
  const section = sectionInput.value || 'daily';
  if(!name || !date){ alert('‡¶®‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶¶‡¶ø‡¶®'); return; }
  const id = Date.now().toString(36) + Math.floor(Math.random()*1000);
  const rec = { id, name, date, description, baki, jama, total, section };

  try{
    await fetch(API_BASE + "/records", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(rec)
    });
    finishedStatus[name] = false;
    await pushFinished();
    await loadFromServer();
    clearAddInputs();
  }catch(e){ console.error(e); alert("Failed to save record"); }
}

function clearAddInputs(){ nameInput.value=''; dateInput.value=''; detailsInput.value=''; bakiInput.value=''; jamaInput.value=''; totalInput.value=''; sectionInput.value='daily'; }

function openEditModal(id){
  const rec = records.find(r=>r.id===id);
  if(!rec) return alert('Record not found');
  editId.value = rec.id; editName.value = rec.name; editDate.value = rec.date; editDetails.value = rec.description; editBaki.value = rec.baki; editJama.value = rec.jama; editTotal.value = rec.total; editSection.value = rec.section || 'daily';
  $('#editModal').modal('show');
}

function closeEditModal(){ $('#editModal').modal('hide'); }

async function saveEdit(){
  const id = editId.value;
  const rec = {
    id,
    name: editName.value.trim(),
    date: editDate.value,
    description: editDetails.value.trim(),
    baki: parseFloat(editBaki.value)||0,
    jama: parseFloat(editJama.value)||0,
    total: parseFloat(editTotal.value)||0,
    section: editSection.value || 'daily'
  };
  try{
    await fetch(API_BASE + "/records/" + id, {
      method:"PUT",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(rec)
    });
    await loadFromServer();
    $('#editModal').modal('hide');
  }catch(e){ console.error(e); alert("Save failed"); }
}

async function deleteRecord(id){
  if(!confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) return;
  try{
    await fetch(API_BASE + "/records/" + id, { method:"DELETE" });
    await loadFromServer();
  }catch(e){ console.error(e); }
}

/* ---------- Render / Search ---------- */
function matchesSearch(rec){
  const q = (globalSearch.value||'').trim().toLowerCase();
  if(!q) return true;
  return (rec.name||'').toLowerCase().includes(q) || (rec.date||'').toLowerCase().includes(q) || (rec.description||'').toLowerCase().includes(q);
}

function renderDailyTable(){
  const tbody = document.querySelector('#dailyTable tbody'); tbody.innerHTML='';
  records.slice().filter(r=>r.section==='daily' || !r.section).sort((a,b)=> new Date(b.date)-new Date(a.date)).filter(matchesSearch).forEach(r=>{
    const tr = document.createElement('tr');
    if((r.description||'').toLowerCase().includes('payment') || (parseFloat(r.jama)||0)>0) tr.classList.add('red');
    const actions = `<td class="admin-only hidden"><button class="btn btn-sm btn-outline-primary" onclick="openEditModal('${r.id}')">Edit</button> <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord('${r.id}')">Delete</button></td>`;
    tr.innerHTML = `<td>${escapeHtml(r.name)}</td><td>${escapeHtml(r.date)}</td><td>${escapeHtml(r.description)}</td><td>${(parseFloat(r.baki)||0).toFixed(2)}</td><td>${(parseFloat(r.jama)||0).toFixed(2)}</td><td>${(parseFloat(r.total)||0).toFixed(2)}</td>${actions}`;
    tbody.appendChild(tr);
  });
}

function renderWorkerTable(){
  const tbody = document.querySelector('#workerTable tbody'); tbody.innerHTML='';
  const map = {};
  records.forEach(r=>{
    const n = r.name || 'Unknown';
    if(!map[n]) map[n] = { baki:0, jama:0, count:0 };
    map[n].baki += parseFloat(r.baki||0);
    map[n].jama += parseFloat(r.jama||0);
    map[n].count += 1;
  });
  Object.keys(map).forEach(name=>{
    const it = map[name];
    const isFinished = finishedStatus[name] || false;
    const redDot = isFinished ? '' : '<span class="red-dot"></span>';
    const checkbox = `<input type="checkbox" ${isFinished?'checked':''} onchange="onToggleFinished('${escapeJS(name)}', this.checked)">`;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><a class="pointer" onclick="showWorkerDetails('${escapeJS(name)}')">${redDot}${escapeHtml(name)}</a></td><td>${it.baki.toFixed(2)}</td><td>${it.jama.toFixed(2)}</td><td>${(it.baki-it.jama).toFixed(2)}</td><td>${it.count}</td><td>${checkbox}</td>`;
    tbody.appendChild(tr);
  });
}

async function onToggleFinished(name, checked){
  finishedStatus[name] = checked;
  await pushFinished();
  await loadFromServer();
}

/* ---------- Worker details & print ---------- */
function showWorkerDetails(name){
  dashboard.classList.add('hidden'); workerDetails.classList.remove('hidden');
  workerTitle.innerText = name + ' - ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡¶æ‡¶∞‡¶ø‡¶§‡¶æ';
  const data = records.filter(r => (r.name||'') === name).slice().sort((a,b)=> new Date(a.date)-new Date(b.date));
  const tbody = workerDetailBody; tbody.innerHTML='';
  let running = 0;
  data.forEach(r=>{
    running += (parseFloat(r.baki||0) - parseFloat(r.jama||0));
    const tr = document.createElement('tr');
    if((r.description||'').toLowerCase().includes('payment') || (parseFloat(r.jama)||0) > 0) tr.classList.add('red');
    tr.innerHTML = `<td>${escapeHtml(r.date)}</td><td>${escapeHtml(r.description)}</td><td>${(parseFloat(r.baki)||0).toFixed(2)}</td><td>${(parseFloat(r.jama)||0).toFixed(2)}</td><td>${(parseFloat(r.total)||0).toFixed(2)}</td><td>${running.toFixed(2)}</td><td><button class="btn btn-sm btn-outline-primary" onclick="openEditModal('${r.id}')">Edit</button></td>`;
    tbody.appendChild(tr);
  });
}

function closeWorkerDetails(){ workerDetails.classList.add('hidden'); dashboard.classList.remove('hidden'); }

/* ---------- Datalist ---------- */
function updateNamesDatalist(){
  const set = new Set(records.map(r=>r.name).filter(Boolean));
  const dl = namesList; dl.innerHTML = '';
  Array.from(set).sort((a,b)=> a.localeCompare(b,'bn')).forEach(n => { const opt = document.createElement('option'); opt.value = n; dl.appendChild(opt); });
}

/* ---------- CSV export/import (client) ---------- */
function exportCSV(){
  if(!records || records.length===0){ alert('No records to export'); return; }
  const headers = ['id','name','date','description','baki','jama','total','section'];
  const rows = records.map(r => headers.map(h => `"${String(r[h] != null ? r[h] : '')}"`).join(','));
  const csv = [headers.join(',')].concat(rows).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'labor_data.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

// Download server CSV
function downloadServerCSV(){ window.location.href = API_BASE + "/export.csv"; }

function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
  if(lines.length===0) return [];
  const headers = splitCSVLine(lines[0]).map(h=>h.trim());
  const rows = [];
  for(let i=1;i<lines.length;i++){
    const vals = splitCSVLine(lines[i]);
    const obj = {};
    headers.forEach((h,idx)=> obj[h] = (vals[idx]||'').replace(/^"|"$/g,''));
    rows.push(obj);
  }
  return rows;
}

function splitCSVLine(line){
  const res = []; let cur='', inQ=false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){ inQ = !inQ; cur += ch; continue; }
    if(ch === ',' && !inQ){ res.push(cur); cur=''; continue; }
    cur += ch;
  }
  res.push(cur); return res;
}

async function importCSV(e){
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = async function(evt){
    try{
      const text = evt.target.result;
      const parsed = parseCSV(text);
      const newRecords = parsed.map((row,i)=>({
        id: row.id || ('imp' + Date.now().toString(36) + i),
        name: row.name || row.Name || '',
        date: row.date || row.Date || '',
        description: row.description || row.Description || row.details || '',
        baki: parseFloat(row.baki || row.Baki || 0) || 0,
        jama: parseFloat(row.jama || row.Joma || 0) || 0,
        total: parseFloat(row.total || 0) || 0,
        section: (row.section||'daily')
      }));
      // push to server via /import to replace all records (you can change to POST individually)
      const res = await fetch(API_BASE + "/import", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(newRecords)
      });
      if(!res.ok) throw new Error("Import failed");
      await loadFromServer();
      alert('Imported CSV successfully');
      csvFile.value = '';
    }catch(err){ console.error(err); alert('Failed to import CSV'); }
  };
  reader.readAsText(file);
}

/* ---------- Utilities ---------- */
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeJS(s){ if(s===null||s===undefined) return ''; return String(s).replace(/'/g,"\\'").replace(/"/g,'\\"'); }

/* ---------- Clear local (not used but kept) ---------- */
function clearAllConfirm(){
  if(!confirm('Are you sure? This will attempt to clear server records by uploading empty set.')) return;
  fetch(API_BASE + "/import", { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify([])}).then(()=>loadFromServer());
}

/* ---------- On load ---------- */
document.addEventListener('DOMContentLoaded', ()=>{ /* waiting for login */ });
// small helper to show admin-only controls when admin logs in
</script>
</body>
</html>
